function initGetParams(){window.onmessage=function(t){console.log("Try to set params e.data="+t.data),cmd=t.data,console.log("cmd=",cmd),app.$data.power_str!=cmd.power&&app.setPower(cmd.power),cmd.hasOwnProperty("tank")&&fillTank(cmd.tank),cmd.hasOwnProperty("batarey")&&fillBatarey(cmd.batarey),cmd.hasOwnProperty("engine")&&drawEngine(cmd.engine);for(var a=0;a<app.$data.engine_params.length;a++){var e=app.$data.engine_params[a][3];cmd.hasOwnProperty(e)&&(app.$data.engine_params[a][1]=cmd[e],$("#e-params-"+a).html(cmd[e]))}}}function setAllTankPictWidth(){for(var t=$(window).width(),a=app.$data.g_pict_dimension[0],e=0;e<app.$data.g_pict_dimension.length;e++)t>app.$data.g_pict_dimension[e]&&(a=app.$data.g_pict_dimension[e]);return a}function calcToday(){var t=new Date;return t.toLocaleDateString()+" "+t.toLocaleTimeString()}function initToday(){jQuery("#datetimepicker").datetimepicker({format:"d.m.Y H:i"}),console.info("DateTime init....")}function initTank_top(){console.log("InitTank_top...."),draw_tank_top=SVG("tank_top").size(300,200),x1=50,y1=0,h=180,l=200,l_skos=20,otstup=20,h_vistup=20}function showViewTank_top(){kontur=[[x1,y1],[x1+l/2,y1],[x1+l/2+otstup,y1+otstup],[x1+l/2+2*otstup,y1+otstup],[x1+l/2+2*otstup,y1+otstup/2],[x1+l/2+3*otstup,y1+otstup/2],[x1+l/2+3*otstup,y1+otstup],[x1+l/2+4*otstup,y1+otstup],[x1+l/2+4*otstup,y1+h],[x1-otstup,y1+h],[x1-otstup,y1+otstup],[x1,y1]],tank_top=draw_tank_top.polyline([kontur]).fill("none").stroke({width:4})}function showFillTank_top(t){console.log("showFillTank_top "+t);var a=h/100*t,e=x1-otstup+4,n=y1+otstup+1+(h-a),i=l-8,o=a-otstup-1;tank_top_fill=draw_tank_top.rect(i,o).fill("green").move(e,n),console.log("tank_top_fill="+tank_top_fill),draw_tank_top.text(t.toString()+" %").move(x1+l/6,y1+2)}function initTank(){draw_tank=SVG("tank").size(300,300),tank_width=160,tank_h=200}function showViewTank(){tank_x1=0,tank_y1=0,draw_tank.rect(tank_width/2,tank_h/6).fill("none").stroke({width:4}).move(tank_x1+tank_width/4,tank_y1),draw_tank.rect(tank_width,tank_h).fill("none").radius(10).stroke({width:4}).move(tank_x1,tank_y1+tank_h/6)}function showFillTank(t){console.log("showFillTank "+t);var a=tank_h/6,e=tank_h/100*t,n=tank_x1+4,i=tank_y1+a+(tank_h-e)+1,o=tank_width-8,p=tank_y1+e-2;tank_fill=draw_tank.rect(o,p).fill("green").move(n,i),draw_tank.text(t.toString()+" %").move(tank_x1+tank_width/2.5,y1+tank_h/2)}function initAllTank(){console.log("InitAllTank..."),cur_pict_width=setAllTankPictWidth(),console.log("Set pict width:"+cur_pict_width);var t=document.getElementById("tank").getContext("2d"),a=document.getElementById("g_all_img");t.drawImage(a,0,0),initGPictKoord(),fillTank(40),fillBatarey(70)}function getMousePos(t,a){var e=t.getBoundingClientRect();return{x:a.clientX-e.left,y:a.clientY-e.top}}function clickOnEngine(t){var a=$("#tank").width()/2,e=$("#tank").width()-5,n=$("#tank").height()/2,i=$("#tank").height()-5;return t.x>a&&t.x<e&&t.y>n&&t.y<i}function drawEngine(t){var a=(document.getElementById("tank"),document.getElementById("tank").getContext("2d"));clearFill("engine");var e=new Image;e.src="images/motor_"+app.$data.cur_pict_width+"_"+t+".png",e.addEventListener("load",function(){a.drawImage(e,e.width,e.height),a.fillStyle="black",a.font=app.$data.g_pict_font,a.fillText(t,app.$data.g_pict.engine.text_x,app.$data.g_pict.engine.text_y),console.log("draw motor img....")},!1)}function initGPictKoord(){app.$data.g_pict.tank.x1=.02*$("#tank").width(),app.$data.g_pict.tank.y1=.12*$("#tank").height(),app.$data.g_pict.tank.width=.96*$("#tank").width(),app.$data.g_pict.tank.height=.15*$("#tank").height(),app.$data.g_pict.tank.text_x=.42*$("#tank").width(),app.$data.g_pict.tank.text_y=.19*$("#tank").height(),app.$data.g_pict.batarey.x1=.085*$("#tank").width(),app.$data.g_pict.batarey.y1=.45*$("#tank").height(),app.$data.g_pict.batarey.width=.33*$("#tank").width(),app.$data.g_pict.batarey.height=.46*$("#tank").height(),app.$data.g_pict.batarey.text_x=.15*$("#tank").width(),app.$data.g_pict.batarey.text_y=.65*$("#tank").height(),app.$data.g_pict.engine.text_x=.62*$("#tank").width(),app.$data.g_pict.engine.text_y=.53*$("#tank").height()}function clearFill(t){var a=document.getElementById("tank").getContext("2d");"tank"==t&&(a.fillStyle="white",a.fillRect(app.$data.g_pict.tank.x1-1,app.$data.g_pict.tank.y1-1,app.$data.g_pict.tank.width+1,app.$data.g_pict.tank.height)),"batarey"==t&&(a.fillStyle="white",a.fillRect(app.$data.g_pict.batarey.x1-1,app.$data.g_pict.batarey.y1,app.$data.g_pict.batarey.width+1,app.$data.g_pict.batarey.height)),"engine"==t&&(a.fillStyle="white",engine_x1=.46*$("#tank").width(),engine_y1=$("#tank").height()/2-.2*$("#tank").height(),engine_width=.52*$("#tank").width(),engine_hight=10+$("#tank").height()/2,a.fillRect(engine_x1,engine_y1,engine_width,engine_hight))}function fillTank(t){if(!(t<0||t>100)){var a=document.getElementById("tank").getContext("2d");clearFill("tank"),a.fillStyle="white",a.fillStyle="#70AC36",x100=app.$data.g_pict.tank.x1,y100=app.$data.g_pict.tank.y1,y_ps=y100+(app.$data.g_pict.tank.height-app.$data.g_pict.tank.height*t/100),h_ps=t*app.$data.g_pict.tank.height/100,a.fillRect(x100,y_ps,app.$data.g_pict.tank.width,h_ps),a.fillStyle="black",a.font=app.$data.g_pict_font,a.fillText(t.toString()+" %",app.$data.g_pict.tank.text_x,app.$data.g_pict.tank.text_y)}}function fillBatarey(t){if(!(t<0||t>100)){var a=document.getElementById("tank").getContext("2d");clearFill("batarey"),a.fillStyle="#70AC36",x100=app.$data.g_pict.batarey.x1,y100=app.$data.g_pict.batarey.y1,y_ps=y100+(app.$data.g_pict.batarey.height-app.$data.g_pict.batarey.height*t/100),h_ps=t*app.$data.g_pict.batarey.height/100,a.fillRect(x100,y_ps,app.$data.g_pict.batarey.width,h_ps),a.fillStyle="black",a.font=app.$data.g_pict_font,a.fillText(t.toString()+" %",app.$data.g_pict.batarey.text_x,app.$data.g_pict.batarey.text_y)}}$(document).ready(function(){app=new Vue({el:"#app",data:{menu:[{label:"Main",isActive:!0},{label:"Current state",isActive:!1},{label:"Statistics",isActive:!1},{label:"Setup",isActive:!1},{label:"DEBUG",isActive:!1}],debug_menu:[{label:"Can Init",isActive:!1,isDisabled:!1,cmd:"can_init"},{label:"AUTO RENEW",isActive:!1,isDisabled:!1,cmd:"auto_renew"},{label:"AUTO STOP",isActive:!1,isDisabled:!1,cmd:"auto_stop"},{label:"INVERTER RENEW",isActive:!1,isDisabled:!1,cmd:"inverter_renew"},{label:"ENGINE RENEW",isActive:!1,isDisabled:!1,cmd:"engine_renew"},{label:"BATTERY RENEW",isActive:!1,isDisabled:!1,cmd:"battery_renew"}],menuActiveIndex:0,error_mes:"",debug_error_mes:"",error_color:"color-green",power_url:"params/plug.php",power_pressed:!1,power_str:"OFF",engine_str:"OFF",g_pict:{tank:{x1:0,y1:0},batarey:{x1:0,y1:0},engine:{text_x:0,text_y:0}},g_pict_dimension:[240,320,370,768],g_pict_font:"32px arial",cur_pict_width:320,generator_name:"Mountain Cabin",generator_name_title:"Mountain Cabin",today:calcToday(),isControlActive:!1,isStatLoading:!1,intervalID:0,statLoadingValue:0,motor_state:0,motor_state_str:"OFF",message:"Mountaine Cabine",tank_fuel_ps:100,tank_top_fuel_ps:100,engine_params:[["Current Load",.3,"kW","cur_load"],["System Temperature",38,"C°","sys_temp"],["Engine Temperature",85,"C°","eng_temp"],["Next Maintenance",28,"day","mainten"]],fuel_params:[["Total kW*h consumed",.5,"kW"],["Total fuel consumed",18,"liter"],["Average kW*h per day",.5,"kW"],["Average fuel per day",1.8,"liter"]]},methods:{menuActive:function(t){$("#menu_modal").removeClass("is-active"),this.menuActiveIndex=t;for(var a=0;a<this.menu.length;a++)this.menu[a].isActive=a==t;2==t&&initCharts(),3==t&&initToday(),console.log(t)},debug_menuActive:function(t){for(var a=0;a<this.debug_menu.length;a++)a==t?(this.debug_menu[a].isActive=!0,this.debug_menu[a].isDisabled=!1,this.send_debug_cmd(a)):(this.debug_menu[a].isActive=!1,this.debug_menu[a].isDisabled=!0)},send_debug_cmd:function(t){var a=this;console.log("send "+a.debug_menu[t].cmd),$.ajax({type:"POST",url:app.$data.power_url,data:{debug_cmd:a.debug_menu[t].cmd},success:function(t){console.log("(success)Debug action return:",t),"done"==t.state?console.log("(!)Debug command done!"):a.debug_error_mes=t.mes},fail:function(t){console.log("(fail)Debug action return:",t)},dataType:"json"}),setTimeout(function(){for(var t=0;t<a.debug_menu.length;t++)a.debug_menu[t].isActive=!1,a.debug_menu[t].isDisabled=!1},2500)},btnMenuClickOpen:function(){$("#menu_modal").addClass("is-active")},btnMenuClickClose:function(){$("#menu_modal").removeClass("is-active")},btnFillTank_top:function(){alert(this.tank_top_fuel_ps),showFillTank_top(this.tank_top_fuel_ps)},btnFillRemove:function(){$("#"+tank_top_fill.attr("id")).remove()},btnMotorClick:function(){0==this.motor_state?(this.motor_state=1,this.motor_state_str="ON"):(this.motor_state=0,this.motor_state_str="OFF")},setPower:function(){this.power_pressed=!0,"OFF"==this.power_str?this.power_str="ON":this.power_str="OFF",$.ajax({type:"POST",url:app.$data.power_url,data:{power:"ON"==this.power_str?1:0},success:function(t){console.log("(success)Power action return:",t),"done"==t.state?(app.$data.power_pressed=!1,app.$data.error_color="color-green",app.$data.error_mes=""):(app.$data.error_color="color-yellow",app.$data.error_mes=t.mes)},fail:function(t){console.log("(fail)Power action return:",t),app.$data.power_pressed=!1,app.$data.error_color="color-red",app.$data.error_mes="Power setup error!"},dataType:"json"}),console.log("Power is:"+this.power_str)},saveControls:function(){this.generator_name_title=this.generator_name}}}),console.log("Screen width:"+$(window).width()),initAllTank(),initGetParams()});